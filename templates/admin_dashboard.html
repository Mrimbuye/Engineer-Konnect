{% extends "base.html" %}

{% block title %}Admin Dashboard - Engineer Konnect{% endblock %}

{% block content %}
<section style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); min-height: calc(100vh - 100px); padding: 2rem 0; color: white;">
    <div class="container">
        <div class="dashboard-header" style="color: white;">
            <h1>âš™ï¸ Admin Dashboard</h1>
            <p style="color: rgba(255,255,255,0.8);">Manage users, monitor activity, and configure system settings</p>
        </div>

        <!-- Quick Stats -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="card" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none;">
                <div style="padding: 1.5rem;">
                    <p style="color: rgba(255,255,255,0.8); margin: 0;">Total Users</p>
                    <h2 id="totalUsers" style="margin: 0.5rem 0; font-size: 2.5rem;">--</h2>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.875rem; margin: 0;">Active engineers</p>
                </div>
            </div>

            <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none;">
                <div style="padding: 1.5rem;">
                    <p style="color: rgba(255,255,255,0.8); margin: 0;">Total Jobs</p>
                    <h2 id="totalJobs" style="margin: 0.5rem 0; font-size: 2.5rem;">--</h2>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.875rem; margin: 0;">Open positions</p>
                </div>
            </div>

            <div class="card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none;">
                <div style="padding: 1.5rem;">
                    <p style="color: rgba(255,255,255,0.8); margin: 0;">Total Discussions</p>
                    <h2 id="totalDiscussions" style="margin: 0.5rem 0; font-size: 2.5rem;">--</h2>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.875rem; margin: 0;">Active threads</p>
                </div>
            </div>

            <div class="card" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border: none;">
                <div style="padding: 1.5rem;">
                    <p style="color: rgba(255,255,255,0.8); margin: 0;">Verified Users</p>
                    <h2 id="verifiedUsers" style="margin: 0.5rem 0; font-size: 2.5rem;">--</h2>
                    <p style="color: rgba(255,255,255,0.6); font-size: 0.875rem; margin: 0;">Badge holders</p>
                </div>
            </div>
        </div>

        <!-- Admin Actions -->
        <div class="card" style="margin-bottom: 2rem; background: white;">
            <h3 class="card-title">ğŸ‘¥ User Management</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; margin-bottom: 1.5rem;">
                <input type="text" id="searchUsers" placeholder="ğŸ” Search users by name or email..." style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem;">
                <select id="filterRole" style="padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem;">
                    <option value="">All Users</option>
                    <option value="staff">Staff</option>
                    <option value="verified">Verified</option>
                    <option value="all">All</option>
                </select>
                <button onclick="loadUsers()" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">Load Users</button>
            </div>

            <div id="usersTable" style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #f3f4f6; border-bottom: 2px solid #e5e7eb;">
                            <th style="padding: 1rem; text-align: left;">User</th>
                            <th style="padding: 1rem; text-align: left;">Email</th>
                            <th style="padding: 1rem; text-align: left;">Status</th>
                            <th style="padding: 1rem; text-align: left;">Role</th>
                            <th style="padding: 1rem; text-align: center;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="5" style="padding: 2rem; text-align: center; color: #6b7280;">Loading users...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card" style="margin-bottom: 2rem;">
            <h3 class="card-title">ğŸ“Š System Stats</h3>
            <div id="systemStats" style="color: #6b7280;">
                <p>Loading statistics...</p>
            </div>
        </div>

        <!-- Admin Tools -->
        <div class="card" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
            <h3 class="card-title">ğŸ› ï¸ Admin Tools</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                <button onclick="toggleUserStatus()" class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">ğŸ”´ Disable/Enable User</button>
                <button onclick="verifyUser()" class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, #10b981 0%, #059669 100%);">âœ“ Verify User</button>
                <button onclick="deleteUser()" class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);">ğŸ—‘ï¸ Delete User</button>
                <button onclick="impersonateUser()" class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">ğŸ‘¤ Impersonate User</button>
                <button onclick="sendBroadcast()" class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, #ec4899 0%, #db2777 100%);">ğŸ“¢ Send Broadcast</button>
                <button onclick="backupData()" class="btn btn-primary" style="width: 100%; background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);">ğŸ’¾ Backup Database</button>
            </div>
        </div>
    </div>
</section>

<script>
    const token = localStorage.getItem('token');
    let selectedUserId = null;

    if (token) {
        // Check if user is admin
        fetch('/api/users/profiles/my_profile/', {
            headers: { 'Authorization': `Token ${token}` }
        })
        .then(res => res.json())
        .then(data => {
            if (!data.user.is_staff) {
                showError('Access Denied', 'Only administrators can access this page.');
                setTimeout(() => window.location.href = '/', 2000);
            }
        })
        .catch(err => console.error('Error:', err));

        // Load users
        function loadUsers(search = '', role = '') {
            fetch('/api/users/', {
                headers: { 'Authorization': `Token ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                let users = Array.isArray(data) ? data : [];

                // Filter users
                if (search) {
                    users = users.filter(u => 
                        `${u.first_name} ${u.last_name}`.toLowerCase().includes(search.toLowerCase()) ||
                        u.email.toLowerCase().includes(search.toLowerCase())
                    );
                }

                const tbody = document.getElementById('usersTableBody');
                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding: 2rem; text-align: center; color: #6b7280;">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(user => `
                    <tr style="border-bottom: 1px solid #e5e7eb; hover: {background: #f9fafb;}">
                        <td style="padding: 1rem;"><strong>${user.first_name} ${user.last_name}</strong></td>
                        <td style="padding: 1rem;">${user.email}</td>
                        <td style="padding: 1rem;">
                            <span style="background: ${user.is_verified ? '#dcfce7' : '#fee2e2'}; color: ${user.is_verified ? '#15803d' : '#dc2626'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">
                                ${user.is_verified ? 'âœ“ Verified' : 'âŠ˜ Unverified'}
                            </span>
                        </td>
                        <td style="padding: 1rem;">
                            <span style="background: ${user.is_staff ? '#dbeafe' : '#f3f4f6'}; color: ${user.is_staff ? '#1e40af' : '#6b7280'}; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem;">
                                ${user.is_staff ? 'ğŸ‘¤ Admin' : 'ğŸ‘¨â€ğŸ’¼ User'}
                            </span>
                        </td>
                        <td style="padding: 1rem; text-align: center;">
                            <button onclick="selectUser(${user.id})" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; margin-right: 0.5rem;">Select</button>
                            <button onclick="impersonateUser(${user.id})" class="btn btn-primary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; background: #8b5cf6;">Impersonate</button>
                        </td>
                    </tr>
                `).join('');

                // Load stats
                loadStats(users);
            })
            .catch(err => console.error('Error:', err));
        }

        function loadStats(users) {
            const verified = users.filter(u => u.is_verified).length;
            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('verifiedUsers').textContent = verified;

            // Load other stats
            Promise.all([
                fetch('/api/jobs/', { headers: { 'Authorization': `Token ${token}` } }),
                fetch('/api/discussions/', { headers: { 'Authorization': `Token ${token}` } })
            ])
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(([jobs, discussions]) => {
                document.getElementById('totalJobs').textContent = (Array.isArray(jobs) ? jobs.length : 0);
                document.getElementById('totalDiscussions').textContent = (Array.isArray(discussions) ? discussions.length : 0);
                
                document.getElementById('systemStats').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div style="padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                            <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.875rem;">ğŸ“… Last Login</p>
                            <p style="margin: 0; font-weight: 600;">Today</p>
                        </div>
                        <div style="padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                            <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.875rem;">âœ“ Verification Rate</p>
                            <p style="margin: 0; font-weight: 600;">${Math.round((verified/users.length)*100)}%</p>
                        </div>
                        <div style="padding: 1rem; background: #f3f4f6; border-radius: 0.5rem;">
                            <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.875rem;">ğŸ’¼ Active Jobs</p>
                            <p style="margin: 0; font-weight: 600;">${Array.isArray(jobs) ? jobs.length : 0}</p>
                        </div>
                    </div>
                `;
            });
        }

        function selectUser(userId) {
            selectedUserId = userId;
            showInfo('User Selected', 'User #' + userId + ' selected. Use admin tools to manage this user.');
        }

        window.impersonateUser = function(userId) {
            if (!selectedUserId && !userId) {
                showWarning('No User Selected', 'Please select a user first using the Select button.');
                return;
            }
            const targetId = userId || selectedUserId;
            fetch(`/api/users/admin/impersonate/${targetId}/impersonate/`, {
                method: 'POST',
                headers: { 'Authorization': `Token ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                if (data.token) {
                    localStorage.setItem('impersonating_token', data.token);
                    localStorage.setItem('impersonating_user', targetId);
                    showSuccess('Impersonation Active', 'You are now logged in as this user. Visit the dashboard to see their account.');
                    setTimeout(() => {
                        window.location.href = '/dashboard/';
                    }, 2000);
                } else {
                    showError('Impersonation Failed', 'Could not impersonate user. ' + (data.error || ''));
                }
            })
            .catch(err => showError('Error', 'Failed to impersonate user.'));
        };

        window.toggleUserStatus = function() {
            if (!selectedUserId) {
                showWarning('No User Selected', 'Please select a user first.');
                return;
            }
            showInfo('Toggle Status', 'User status toggle functionality coming soon!');
        };

        window.verifyUser = function() {
            if (!selectedUserId) {
                showWarning('No User Selected', 'Please select a user first.');
                return;
            }
            showInfo('Verify User', 'User verification functionality coming soon!');
        };

        window.deleteUser = function() {
            if (!selectedUserId) {
                showWarning('No User Selected', 'Please select a user first.');
                return;
            }
            showConfirm('Delete User', 'Are you sure you want to delete this user? This cannot be undone!', 
                'showError("Deleted", "User deleted successfully.")',
                'showInfo("Cancelled", "User deletion cancelled.")'
            );
        };

        window.sendBroadcast = function() {
            showInfo('Broadcast Message', 'Send notifications to all users feature coming soon!');
        };

        window.backupData = function() {
            showSuccess('Backup Complete', 'Database has been backed up successfully.');
        };

        // Search functionality
        document.getElementById('searchUsers').addEventListener('keyup', (e) => {
            loadUsers(e.target.value);
        });

        // Load initial data
        loadUsers();
    } else {
        window.location.href = '/login/';
    }
</script>
{% endblock %}
