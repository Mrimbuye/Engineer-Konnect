{% extends "base.html" %}

{% block title %}Messages - Engineer Konnect{% endblock %}

{% block content %}
<section style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); min-height: calc(100vh - 100px); padding: 2rem 0;">
    <div class="container">
        <div class="dashboard-header">
            <h1>ðŸ’¬ Messages & Network</h1>
            <p class="text-muted">Stay connected with your engineering community</p>
        </div>

        <div style="display: grid; grid-template-columns: 320px 1fr 300px; gap: 2rem; margin-top: 2rem;">
            <!-- Conversations List -->
            <div>
                <div class="card" style="position: sticky; top: 20px;">
                    <h3 class="card-title" style="margin: 0 0 1rem 0;">ðŸ’¼ Your Conversations</h3>
                    <div style="margin-bottom: 1rem;">
                        <input type="text" placeholder="ðŸ” Search conversations..." id="searchConv" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 0.5rem; font-size: 0.875rem;">
                    </div>
                    <div id="conversations" style="max-height: 600px; overflow-y: auto;">
                        <p class="text-muted" style="text-align: center;">Loading conversations...</p>
                    </div>
                </div>
            </div>

            <!-- Message Thread -->
            <div class="card" style="display: flex; flex-direction: column; height: 700px;">
                <div style="padding: 1rem; border-bottom: 2px solid #f0f0f0;">
                    <h3 id="selectedUser" class="card-title" style="margin: 0;">ðŸ‘¥ Select a conversation</h3>
                    <p class="text-muted" style="margin: 0.5rem 0 0 0; font-size: 0.875rem;" id="userStatus">No conversation selected</p>
                </div>
                
                <div id="messageThread" style="flex: 1; overflow-y: auto; padding: 1.5rem; background: #fafbfc; display: flex; flex-direction: column; gap: 1rem;">
                    <p class="text-muted" style="text-align: center; margin-top: 2rem;">No conversation selected</p>
                </div>

                <div style="padding: 1rem; border-top: 2px solid #f0f0f0; background: #fff;">
                    <div style="display: flex; gap: 0.5rem;">
                        <textarea id="messageInput" placeholder="Type your message (Ctrl+V to paste, Shift+Enter for new line)..." style="flex: 1; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; resize: none; font-size: 0.95rem; font-family: inherit;" rows="3"></textarea>
                        <button id="sendBtn" class="btn btn-primary" style="padding: 0.75rem 1.5rem; align-self: flex-end; border-radius: 0.5rem; cursor: pointer; transition: all 0.3s;">ðŸ“¤ Send</button>
                    </div>
                    <small class="text-muted" style="display: block; margin-top: 0.5rem;">ðŸ’¡ Tip: You can paste images and text freely</small>
                </div>
            </div>

            <!-- Quick Connections -->
            <div>
                <div class="card" style="position: sticky; top: 20px;">
                    <h3 class="card-title" style="margin: 0 0 1rem 0;">ðŸ‘« Quick Connections</h3>
                    <a href="/connections/" class="btn btn-primary" style="width: 100%; text-align: center; margin-bottom: 1rem;">+ Find Engineers</a>
                    <div id="quickConnections" style="max-height: 600px; overflow-y: auto;">
                        <p class="text-muted" style="text-align: center; font-size: 0.875rem;">Loading suggestions...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    const token = localStorage.getItem('token');
    let selectedConvId = null;

    if (token) {
        // Load conversations
        function loadConversations(searchTerm = '') {
            fetch('/api/messages/', {
                headers: { 'Authorization': `Token ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                const conversationsDiv = document.getElementById('conversations');
                if (Array.isArray(data) && data.length > 0) {
                    const filtered = data.filter(conv => 
                        conv.participants?.[0]?.username?.toLowerCase().includes(searchTerm.toLowerCase())
                    );
                    
                    if (filtered.length === 0) {
                        conversationsDiv.innerHTML = '<p class="text-muted" style="text-align: center;">No matches found</p>';
                        return;
                    }
                    
                    conversationsDiv.innerHTML = filtered.map((conv, idx) => {
                        const username = conv.participants?.[0]?.username || 'Unknown';
                        const lastMsg = conv.last_message || 'No messages yet';
                        return `
                            <div class="conversation-item" onclick="selectConversation(${conv.id}, '${username}')" style="padding: 1rem; margin-bottom: 0.5rem; background: #fff; border: 2px solid #e5e7eb; border-radius: 0.5rem; cursor: pointer; transition: all 0.3s; user-select: none;">
                                <p style="margin: 0; font-weight: 600; color: #1f2937;">ðŸ‘¤ ${username}</p>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.825rem; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${lastMsg}</p>
                            </div>
                        `;
                    }).join('');

                    // Add hover effects
                    document.querySelectorAll('.conversation-item').forEach(item => {
                        item.addEventListener('mouseover', () => {
                            item.style.borderColor = '#2563eb';
                            item.style.boxShadow = '0 0 8px rgba(37, 99, 235, 0.2)';
                        });
                        item.addEventListener('mouseout', () => {
                            item.style.borderColor = '#e5e7eb';
                            item.style.boxShadow = 'none';
                        });
                    });
                } else {
                    conversationsDiv.innerHTML = '<p class="text-muted" style="text-align: center;">No conversations yet.<br><a href="/connections/">Find engineers to connect</a></p>';
                }
            })
            .catch(err => console.error('Error:', err));
        }

        // Load quick connections
        function loadQuickConnections() {
            fetch('/api/users/', {
                headers: { 'Authorization': `Token ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                const quickDiv = document.getElementById('quickConnections');
                if (Array.isArray(data) && data.length > 0) {
                    quickDiv.innerHTML = data.slice(0, 5).map(user => `
                        <div style="padding: 1rem; background: #f9fafb; border-radius: 0.5rem; margin-bottom: 0.5rem; border-left: 4px solid #2563eb;">
                            <p style="margin: 0; font-weight: 600; color: #1f2937;">${user.first_name || user.username}</p>
                            <p style="margin: 0.25rem 0; font-size: 0.75rem; color: #6b7280;">Engineer</p>
                            <button onclick="createConversation(${user.id})" class="btn btn-primary" style="width: 100%; margin-top: 0.5rem; padding: 0.4rem; font-size: 0.85rem; border-radius: 0.375rem;">Message</button>
                        </div>
                    `).join('');
                }
            })
            .catch(err => console.error('Error loading users:', err));
        }

        // Select conversation
        window.selectConversation = function(convId, username) {
            selectedConvId = convId;
            document.getElementById('selectedUser').textContent = 'ðŸ‘¥ ' + username;
            document.getElementById('userStatus').textContent = 'Active now';
            document.getElementById('messageThread').innerHTML = '<p class="text-muted" style="text-align: center;">Messages will load here</p>';
            document.getElementById('messageInput').focus();
        };

        // Create new conversation
        window.createConversation = function(userId) {
            // This would create a new conversation with the user
            alert('Starting conversation with user ' + userId);
        };

        // Search conversations
        document.getElementById('searchConv').addEventListener('input', (e) => {
            loadConversations(e.target.value);
        });

        // Send message
        document.getElementById('sendBtn').addEventListener('click', () => {
            const message = document.getElementById('messageInput').value.trim();
            if (message && selectedConvId) {
                // Send message to API
                fetch(`/api/messages/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        conversation_id: selectedConvId,
                        content: message
                    })
                })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('messageInput').value = '';
                    loadConversations();
                })
                .catch(err => console.error('Error sending message:', err));
            } else if (!selectedConvId) {
                alert('Please select a conversation first');
            }
        });

        // Allow Ctrl+Enter to send
        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                document.getElementById('sendBtn').click();
            }
        });

        loadConversations();
        loadQuickConnections();
    } else {
        window.location.href = '/login/';
    }
</script>
{% endblock %}
